with cte_with_prev_at as (
    select
        "user",
        slug,
        at,
        lagInFrame(at) over (partition by (user, slug) order by ts) as prev_at,
        if(prev_at == 0 or prev_at > at, 0, at - prev_at) as duration
    from watch_events
), aggregated_data as(
    select user, slug, sum(duration) as added_watchtime from cte_with_prev_at
    group by (user, slug)
)
select * from aggregated_data
where added_watchtime > 0;


create table if not exists watch_events_kafka_queue (
    user varchar(100),
    slug varchar(100),
    at bigint
) engine Kafka() settings
    kafka_broker_list = 'localhost:9092',
    kafka_topic_list = 'watch_events',
    kafka_group_name = 'clickhouse_watch_events_consumer',
    kafka_format = 'CSV',
    kafka_thread_per_consumer = 1,
    kafka_num_consumers = 4,
    kafka_client_id = 'clickhouse-001';;

create table if not exists watch_events (
    user varchar(100),
    slug varchar(100),
    at bigint,
    ts timestamp default now()
) engine MergeTree order by ts;


drop view watch_events_mv;
CREATE MATERIALIZED VIEW watch_events_mview TO watch_events AS
SELECT *
FROM watch_events_kafka_queue;